<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glossary Generator - Atlan</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%232026d2'/><text x='50' y='70' font-size='60' text-anchor='middle' fill='white' font-family='system-ui'>G</text></svg>">
</head>
<body>
    <!-- Toast Notification Container -->
    <div id="toast-container" class="toast-container"></div>

    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">
                        <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                            <rect width="32" height="32" rx="8" fill="#2026d2"/>
                            <path d="M9 12h6v2H9v-2zm0 4h14v2H9v-2zm0 4h10v2H9v-2z" fill="white"/>
                        </svg>
                    </div>
                    <div>
                        <h1>Business Glossary Generator</h1>
                        <p class="subtitle">AI-powered glossary terms from your data catalog</p>
                    </div>
                </div>
                <div class="header-badge">
                    <span class="beta-badge">Beta</span>
                </div>
            </div>
        </header>

        <nav class="nav-tabs">
            <a href="/" class="nav-tab active">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M8 2l6 4v7a1 1 0 01-1 1H3a1 1 0 01-1-1V6l6-4z"/>
                </svg>
                Generate
            </a>
            <a href="/review" class="nav-tab">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M3 3h10a1 1 0 011 1v8a1 1 0 01-1 1H3a1 1 0 01-1-1V4a1 1 0 011-1zm2 3h6v1H5V6zm0 3h4v1H5V9z"/>
                </svg>
                Review Terms
            </a>
            <a href="/settings" class="nav-tab">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M8 10a2 2 0 100-4 2 2 0 000 4z"/>
                    <path d="M9.5 2.5l.5 1.5 1.5.5-1.5.5-.5 1.5-.5-1.5-1.5-.5 1.5-.5.5-1.5z"/>
                </svg>
                Settings
            </a>
        </nav>

        <main>
            <!-- Quick Stats -->
            <div class="quick-stats">
                <div class="stat-item">
                    <div class="stat-icon stat-icon-primary">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10 2a8 8 0 100 16 8 8 0 000-16zM9 5h2v6H9V5zm0 8h2v2H9v-2z"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="dataSourceLabel">MDLH Direct</div>
                        <div class="stat-label">Data Source</div>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon stat-icon-success">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10 3a7 7 0 100 14 7 7 0 000-14zm3.5 6l-4 4-2-2 .7-.7 1.3 1.3 3.3-3.3.7.7z"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">AI-Powered</div>
                        <div class="stat-label">Claude Sonnet 4</div>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon stat-icon-info">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M4 4h12a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2zm2 4h8v1H6V8zm0 3h6v1H6v-1z"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">Auto-Review</div>
                        <div class="stat-label">Quality Checks</div>
                    </div>
                </div>
            </div>

            <section class="card main-card">
                <div class="card-header-section">
                    <h2>
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10 2l5 3v5a6 6 0 01-5 5.9A6 6 0 015 10V5l5-3z"/>
                        </svg>
                        Configure Generation Workflow
                    </h2>
                    <p class="card-description">Select your target glossary and data sources to generate AI-powered term definitions</p>
                </div>

                <form id="workflowForm">
                    <!-- Step 1: Target & Source -->
                    <div class="form-section">
                        <div class="form-section-header">
                            <span class="form-section-number">1</span>
                            <div>
                                <h3 class="form-section-title">Target & Source</h3>
                                <p class="form-section-desc">Where to save terms and which data to scan</p>
                            </div>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="glossarySelect">
                                    <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor" class="label-icon">
                                        <path d="M2 2h10a1 1 0 011 1v8a1 1 0 01-1 1H2a1 1 0 01-1-1V3a1 1 0 011-1z"/>
                                    </svg>
                                    Target Glossary
                                    <span class="required">*</span>
                                </label>
                                <div class="select-wrapper">
                                    <select id="glossarySelect" name="target_glossary" required>
                                        <option value="">Loading glossaries...</option>
                                    </select>
                                    <svg class="select-icon" width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
                                        <path d="M6 8L2 4h8L6 8z"/>
                                    </svg>
                                </div>
                                <!-- Inline create glossary form -->
                                <div id="createGlossaryInline" style="display:none; margin-top: 10px;">
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <input type="text" id="newGlossaryName" placeholder="New glossary name" style="flex:1; padding:10px 14px; border:2px solid var(--atlan-border); border-radius:var(--atlan-radius-sm); font-size:0.9rem;">
                                        <button type="button" class="btn btn-primary btn-sm" onclick="createNewGlossary()">Create</button>
                                        <button type="button" class="btn btn-secondary btn-sm" onclick="cancelCreateGlossary()">Cancel</button>
                                    </div>
                                </div>
                                <small>Glossary where AI-generated terms will be saved for review</small>
                            </div>

                            <div class="form-group">
                                <label for="connectorSelect">
                                    <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor" class="label-icon">
                                        <path d="M7 1a6 6 0 100 12A6 6 0 007 1zm0 9l-3-3h6L7 10z"/>
                                    </svg>
                                    Connector Type
                                </label>
                                <div class="select-wrapper">
                                    <select id="connectorSelect" name="connector_type">
                                        <option value="">Loading connectors...</option>
                                    </select>
                                    <svg class="select-icon" width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
                                        <path d="M6 8L2 4h8L6 8z"/>
                                    </svg>
                                </div>
                                <small>Filter assets by data source type (optional)</small>
                            </div>

                            <div class="form-group">
                                <label for="connectionSelect">
                                    <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor" class="label-icon">
                                        <path d="M12 6H8V2a1 1 0 00-2 0v4H2a1 1 0 000 2h4v4a1 1 0 002 0V8h4a1 1 0 000-2z"/>
                                    </svg>
                                    Specific Connection
                                </label>
                                <div class="select-wrapper">
                                    <select id="connectionSelect" name="connection_qn">
                                        <option value="">Select a connector type first</option>
                                    </select>
                                    <svg class="select-icon" width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
                                        <path d="M6 8L2 4h8L6 8z"/>
                                    </svg>
                                </div>
                                <small>Narrow down to a specific connection (optional)</small>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Generation Settings -->
                    <div class="form-section">
                        <div class="form-section-header">
                            <span class="form-section-number">2</span>
                            <div>
                                <h3 class="form-section-title">Generation Settings</h3>
                                <p class="form-section-desc">Choose term types and how many to create</p>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>
                                <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor" class="label-icon">
                                    <path d="M3 3h8a1 1 0 011 1v6a1 1 0 01-1 1H3a1 1 0 01-1-1V4a1 1 0 011-1zm2 2v1h4V5H5zm0 3v1h3V8H5z"/>
                                </svg>
                                Term Types to Generate
                            </label>
                            <div class="term-type-checkboxes">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="term_type" value="business_term" checked>
                                    <span class="badge badge-business_term">Business Terms</span>
                                    <span class="checkbox-desc">Business concepts from tables and views</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="term_type" value="metric" checked>
                                    <span class="badge badge-metric">Metrics</span>
                                    <span class="checkbox-desc">Numeric values and KPIs (revenue, count, conversion rate)</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="term_type" value="dimension" checked>
                                    <span class="badge badge-dimension">Dimensions</span>
                                    <span class="checkbox-desc">Categorical attributes (status, region, segment)</span>
                                </label>
                            </div>
                            <small>The AI classifies each term into the selected types based on the asset context.</small>
                        </div>

                        <div class="form-group" style="margin-top: 16px;">
                            <label for="maxTerms">
                                <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor" class="label-icon">
                                    <path d="M2 3h10v2H2V3zm0 4h7v2H2V7zm0 4h10v2H2v-2z"/>
                                </svg>
                                Number of Terms
                            </label>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <input type="range" id="maxTermsRange" min="1" max="15" value="10"
                                       style="flex: 1; accent-color: var(--atlan-primary);"
                                       oninput="document.getElementById('maxTermsValue').textContent = this.value; document.getElementById('maxTerms').value = this.value;">
                                <span id="maxTermsValue" style="font-weight: 600; font-size: 1.1rem; min-width: 24px; text-align: center;">10</span>
                                <input type="hidden" id="maxTerms" value="10">
                            </div>
                            <small>Maximum number of glossary terms to create in this run (1-15)</small>
                        </div>
                    </div>

                    <!-- Step 3: Additional Context -->
                    <div class="form-section">
                        <div class="form-section-header">
                            <span class="form-section-number">3</span>
                            <div>
                                <h3 class="form-section-title">Additional Context</h3>
                                <p class="form-section-desc">Optional files to improve term quality</p>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="upload-zone" id="uploadZone">
                                <svg width="32" height="32" viewBox="0 0 32 32" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M16 6v14M10 12l6-6 6 6"/>
                                    <path d="M6 22v2a2 2 0 002 2h16a2 2 0 002-2v-2"/>
                                </svg>
                                <p>Drag & drop files here or <button type="button" class="upload-browse-btn" onclick="document.getElementById('fileInput').click()">browse</button></p>
                                <p class="upload-hint">CSV, PDF, MD, TXT, JSON â€” max 10MB per file</p>
                                <input type="file" id="fileInput" style="display:none;" accept=".csv,.pdf,.md,.txt,.json" multiple>
                            </div>
                            <div class="upload-file-list" id="uploadFileList"></div>
                            <small>Upload data dictionaries, docs, or schemas to improve term quality</small>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary btn-large" id="startBtn">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M4 3l8 5-8 5V3z"/>
                            </svg>
                            <span class="btn-text">Start Generation</span>
                            <span class="btn-loader" style="display: none;">
                                <svg class="spinner" width="16" height="16" viewBox="0 0 16 16">
                                    <circle cx="8" cy="8" r="6" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="30" stroke-dashoffset="0"/>
                                </svg>
                            </span>
                        </button>
                        <div class="form-hint">
                            <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor">
                                <path d="M7 1a6 6 0 100 12A6 6 0 007 1zm0 3v4h1V4H7zm0 6h1v1H7v-1z"/>
                            </svg>
                            Generation typically takes under 1 minute
                        </div>
                    </div>
                </form>
            </section>

            <section class="card status-card" id="statusSection" style="display: none;">
                <div class="card-header-section">
                    <h2>
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10 2a8 8 0 100 16 8 8 0 000-16zm1 11H9v-2h2v2zm0-4H9V5h2v4z"/>
                        </svg>
                        Workflow Progress
                    </h2>
                </div>

                <div class="status-container-enhanced">
                    <div class="status-main">
                        <div class="status-info-row">
                            <div class="status-info-item">
                                <span class="status-label">Workflow ID</span>
                                <code id="workflowId" class="status-code">-</code>
                            </div>
                            <div class="status-info-item">
                                <span class="status-label">Current Status</span>
                                <span id="workflowStatus" class="status-value badge">-</span>
                            </div>
                        </div>

                        <!-- Step Timeline -->
                        <div class="workflow-timeline" id="workflowTimeline">
                            <div class="timeline-step" data-step="validating">
                                <div class="timeline-connector"></div>
                                <div class="timeline-circle">1</div>
                                <div class="timeline-label">Validate</div>
                            </div>
                            <div class="timeline-step" data-step="fetching_metadata">
                                <div class="timeline-connector"></div>
                                <div class="timeline-circle">2</div>
                                <div class="timeline-label">Fetch Metadata</div>
                            </div>
                            <div class="timeline-step" data-step="fetching_usage">
                                <div class="timeline-connector"></div>
                                <div class="timeline-circle">3</div>
                                <div class="timeline-label">Usage Signals</div>
                            </div>
                            <div class="timeline-step" data-step="prioritizing">
                                <div class="timeline-connector"></div>
                                <div class="timeline-circle">4</div>
                                <div class="timeline-label">Prioritize</div>
                            </div>
                            <div class="timeline-step" data-step="generating_definitions">
                                <div class="timeline-connector"></div>
                                <div class="timeline-circle">5</div>
                                <div class="timeline-label">Generate Terms</div>
                            </div>
                            <div class="timeline-step" data-step="saving_drafts">
                                <div class="timeline-connector"></div>
                                <div class="timeline-circle">6</div>
                                <div class="timeline-label">Save Drafts</div>
                            </div>
                            <div class="timeline-step" data-step="notifying">
                                <div class="timeline-circle">7</div>
                                <div class="timeline-label">Notify</div>
                            </div>
                        </div>

                        <div class="progress-section">
                            <div class="progress-header">
                                <span class="progress-label">Progress</span>
                                <span id="progressText" class="progress-percentage">0%</span>
                            </div>
                            <div class="progress-bar-enhanced">
                                <div class="progress-fill-enhanced" id="progressBar" style="width: 0%">
                                    <div class="progress-shine"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Activity Log -->
                        <div class="log-header">
                            <div class="log-dot" id="logDot"></div>
                            <h3>Activity Log</h3>
                        </div>
                        <div class="activity-log" id="activityLog">
                            <div class="log-empty">Waiting for workflow to start...</div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <div class="footer-content">
                <p>Powered by <strong>Atlan Application SDK</strong> â€¢ AI by <strong>Claude Sonnet 4</strong></p>
                <p class="footer-meta">Â© 2026 Atlan â€¢ Business Glossary Generator v1.0</p>
            </div>
        </footer>
    </div>

    <script>
        const form = document.getElementById('workflowForm');
        const statusSection = document.getElementById('statusSection');
        const startBtn = document.getElementById('startBtn');
        const btnText = startBtn.querySelector('.btn-text');
        const btnLoader = startBtn.querySelector('.btn-loader');
        let pollInterval = null;

        // Toast notification system
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icons = {
                success: '<svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zm3.5 6.5l-4 4-2-2 .7-.7 1.3 1.3 3.3-3.3.7.7z"/></svg>',
                error: '<svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zm1 11H9v-2h2v2zm0-4H9V5h2v4z"/></svg>',
                warning: '<svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor"><path d="M10 1l9 16H1L10 1zm1 12H9v2h2v-2zm0-6H9v4h2V7z"/></svg>',
                info: '<svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zm1 11H9v-2h2v2zm0-4H9V5h2v4z"/></svg>'
            };
            
            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.info}</div>
                <div class="toast-message">${message}</div>
                <button class="toast-close" onclick="this.parentElement.remove()">Ã—</button>
            `;
            
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // Set loading state
        function setLoading(loading) {
            startBtn.disabled = loading;
            if (loading) {
                btnText.style.display = 'none';
                btnLoader.style.display = 'inline-flex';
            } else {
                btnText.style.display = 'inline';
                btnLoader.style.display = 'none';
            }
        }

        // Load settings and dropdowns on page load
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('/api/v1/settings');
                const settings = await response.json();

                // Show warning if not configured
                if (!settings.is_configured) {
                    showToast('âš ï¸ Please configure your API credentials in Settings before starting', 'warning');
                }

                // Update data source label
                const useMDLH = settings.snowflake_account && settings.snowflake_user;
                document.getElementById('dataSourceLabel').textContent = useMDLH ? 'MDLH Direct' : 'Atlan SDK';
                
            } catch (error) {
                console.error('Error loading settings:', error);
                showToast('Failed to load application settings', 'error');
            }

            // Load glossaries
            await loadGlossaries();

            // Show/hide create glossary form on select change
            document.getElementById('glossarySelect').addEventListener('change', (e) => {
                const createSection = document.getElementById('createGlossaryInline');
                if (e.target.value === '__create_new__') {
                    createSection.style.display = 'block';
                    document.getElementById('newGlossaryName').focus();
                } else {
                    createSection.style.display = 'none';
                }
            });

            // Load connectors
            await loadConnectors();

            // Set up connector change handler
            document.getElementById('connectorSelect').addEventListener('change', async (e) => {
                await loadConnections(e.target.value);
            });
        });

        async function loadGlossaries() {
            const glossarySelect = document.getElementById('glossarySelect');
            try {
                const response = await fetch('/api/v1/glossaries');
                const data = await response.json();

                glossarySelect.innerHTML = '<option value="">Select a glossary</option>';

                if (data.glossaries && data.glossaries.length > 0) {
                    let foundGlossaryBuddy = false;

                    data.glossaries.forEach(glossary => {
                        const option = document.createElement('option');
                        option.value = glossary.qualified_name;
                        option.textContent = glossary.name;

                        // Set "Glossary Buddy" as default if it exists
                        if (glossary.name === "Glossary Buddy") {
                            option.selected = true;
                            foundGlossaryBuddy = true;
                        }

                        glossarySelect.appendChild(option);
                    });

                    console.log(`âœ“ Loaded ${data.glossaries.length} glossaries` +
                               (foundGlossaryBuddy ? ' (Glossary Buddy set as default)' : ''));
                } else {
                    glossarySelect.innerHTML = '<option value="">No glossaries found</option>';
                }

                // Always add "Create New" option at the end
                const createOpt = document.createElement('option');
                createOpt.value = '__create_new__';
                createOpt.textContent = '+ Create New Glossary';
                glossarySelect.appendChild(createOpt);
            } catch (error) {
                console.error('Error loading glossaries:', error);
                glossarySelect.innerHTML = '<option value="">Error loading glossaries</option>';
                showToast('Failed to load glossaries. Check your connection.', 'error');
            }
        }

        async function loadConnectors() {
            const connectorSelect = document.getElementById('connectorSelect');
            try {
                const response = await fetch('/api/v1/connectors');
                const data = await response.json();

                connectorSelect.innerHTML = '<option value="">All Connectors</option>';

                if (data.connectors && data.connectors.length > 0) {
                    data.connectors.forEach(connector => {
                        const option = document.createElement('option');
                        option.value = connector.value;
                        option.textContent = connector.label;
                        connectorSelect.appendChild(option);
                    });

                    console.log(`âœ“ Loaded ${data.connectors.length} connector types`);
                }
            } catch (error) {
                console.error('Error loading connectors:', error);
                connectorSelect.innerHTML = '<option value="">Error loading connectors</option>';
                showToast('Failed to load connector types', 'error');
            }
        }

        async function loadConnections(connectorType) {
            const connectionSelect = document.getElementById('connectionSelect');

            if (!connectorType) {
                connectionSelect.innerHTML = '<option value="">Select a connector type first</option>';
                return;
            }

            connectionSelect.innerHTML = '<option value="">Loading connections...</option>';

            try {
                const url = `/api/v1/connections?connector_type=${encodeURIComponent(connectorType)}`;
                const response = await fetch(url);
                const data = await response.json();

                connectionSelect.innerHTML = '<option value="">All Connections</option>';

                if (data.connections && data.connections.length > 0) {
                    data.connections.forEach(connection => {
                        const option = document.createElement('option');
                        option.value = connection.qualified_name;
                        option.textContent = connection.name;
                        connectionSelect.appendChild(option);
                    });

                    console.log(`âœ“ Loaded ${data.connections.length} connections for ${connectorType}`);
                } else {
                    connectionSelect.innerHTML = '<option value="">No connections found</option>';
                    showToast(`No connections found for ${connectorType}`, 'info');
                }
            } catch (error) {
                console.error('Error loading connections:', error);
                connectionSelect.innerHTML = '<option value="">Error loading connections</option>';
                showToast('Failed to load connections', 'error');
            }
        }

        async function createNewGlossary() {
            const nameInput = document.getElementById('newGlossaryName');
            const name = nameInput.value.trim();
            if (!name) {
                showToast('Please enter a glossary name', 'warning');
                nameInput.focus();
                return;
            }
            try {
                const response = await fetch('/api/v1/glossaries', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name }),
                });
                const data = await response.json();
                if (data.error) {
                    showToast(`Failed to create glossary: ${data.error}`, 'error');
                    return;
                }
                showToast(`Glossary "${data.glossary.name}" created!`, 'success');
                const newQn = data.glossary.qualified_name;
                // Reload dropdown and auto-select
                await loadGlossaries();
                document.getElementById('glossarySelect').value = newQn;
                document.getElementById('createGlossaryInline').style.display = 'none';
                nameInput.value = '';
            } catch (error) {
                showToast(`Error creating glossary: ${error.message}`, 'error');
            }
        }

        function cancelCreateGlossary() {
            document.getElementById('glossarySelect').value = '';
            document.getElementById('createGlossaryInline').style.display = 'none';
            document.getElementById('newGlossaryName').value = '';
        }

        // ---- File Upload ----
        let uploadedFileIds = [];

        (function initUploadZone() {
            const zone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');

            zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('drag-active'); });
            zone.addEventListener('dragleave', () => { zone.classList.remove('drag-active'); });
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('drag-active');
                handleFiles(e.dataTransfer.files);
            });
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
                fileInput.value = '';
            });
        })();

        async function handleFiles(files) {
            for (const file of files) {
                if (file.size > 10 * 1024 * 1024) {
                    showToast(`File "${file.name}" exceeds 10MB limit`, 'warning');
                    continue;
                }
                const formData = new FormData();
                formData.append('file', file);
                try {
                    const response = await fetch('/api/v1/upload-context', { method: 'POST', body: formData });
                    const data = await response.json();
                    if (data.error) {
                        showToast(data.error, 'error');
                        continue;
                    }
                    uploadedFileIds.push(data.upload_id);
                    renderUploadedFiles(data);
                    showToast(`Uploaded "${data.filename}" (${data.char_count} chars)`, 'success');
                } catch (error) {
                    showToast(`Upload failed: ${error.message}`, 'error');
                }
            }
        }

        function renderUploadedFiles(newFile) {
            const list = document.getElementById('uploadFileList');
            const item = document.createElement('div');
            item.className = 'upload-file-item';
            item.dataset.uploadId = newFile.upload_id;
            const sizeStr = newFile.char_count > 1000 ? `${(newFile.char_count / 1000).toFixed(1)}k chars` : `${newFile.char_count} chars`;
            item.innerHTML = `
                <span class="upload-file-name">${escapeHtml(newFile.filename)}</span>
                <span class="upload-file-size">${sizeStr}</span>
                <button type="button" class="upload-file-remove" onclick="removeUploadedFile('${newFile.upload_id}', this)">&times;</button>
            `;
            list.appendChild(item);
        }

        async function removeUploadedFile(uploadId, btn) {
            try {
                await fetch(`/api/v1/upload-context/${uploadId}`, { method: 'DELETE' });
            } catch (e) { /* ignore */ }
            uploadedFileIds = uploadedFileIds.filter(id => id !== uploadId);
            btn.closest('.upload-file-item').remove();
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            setLoading(true);

            const glossaryQn = document.getElementById('glossarySelect').value;
            if (!glossaryQn || glossaryQn === '__create_new__') {
                showToast('Please select a target glossary', 'warning');
                setLoading(false);
                return;
            }

            // Collect selected term types
            const selectedTermTypes = Array.from(
                document.querySelectorAll('input[name="term_type"]:checked')
            ).map(cb => cb.value);

            if (selectedTermTypes.length === 0) {
                showToast('Please select at least one term type to generate', 'warning');
                setLoading(false);
                return;
            }

            const maxTerms = parseInt(document.getElementById('maxTerms').value) || 10;

            const config = {
                target_glossary_qn: glossaryQn,
                connector_type: document.getElementById('connectorSelect').value || null,
                connection_qualified_name: document.getElementById('connectionSelect').value || null,
                asset_types: ["Table", "View", "MaterializedView"],
                max_assets: Math.min(maxTerms * 2, 30),
                min_popularity_score: 0,
                batch_size: 10,
                max_terms: maxTerms,
                term_types: selectedTermTypes,
                context_upload_ids: uploadedFileIds.length > 0 ? uploadedFileIds : null,
            };

            try {
                const response = await fetch('/workflows/v1/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config),
                });

                const result = await response.json();

                if (result.error) {
                    showToast(`Failed to start workflow: ${result.error}`, 'error');
                    setLoading(false);
                    return;
                }

                document.getElementById('workflowId').textContent = result.workflow_id;
                // Reset log state for new workflow
                lastLogCount = 0;
                document.getElementById('activityLog').innerHTML = '<div class="log-empty">Waiting for workflow to start...</div>';
                _lastTimelineStatus = null;
                document.querySelectorAll('.timeline-step').forEach(s => s.classList.remove('completed', 'active', 'failed'));
                document.getElementById('logDot').classList.remove('inactive');
                statusSection.style.display = 'block';
                statusSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                showToast('ðŸš€ Workflow started successfully!', 'success');
                startPolling(result.workflow_id);

            } catch (error) {
                showToast(`Error starting workflow: ${error.message}`, 'error');
                setLoading(false);
            }
        });

        function startPolling(workflowId) {
            updateStatus(workflowId);
            pollInterval = setInterval(() => updateStatus(workflowId), 2000);
        }

        // Timeline step order for comparison
        const STEP_ORDER = ['validating', 'fetching_metadata', 'fetching_usage', 'prioritizing', 'generating_definitions', 'saving_drafts', 'notifying', 'completed'];
        let lastLogCount = 0;

        let _lastTimelineStatus = null;
        function updateTimeline(currentStatus) {
            // Skip update if status hasn't changed â€” avoids CSS transition flash
            if (currentStatus === _lastTimelineStatus) return;
            _lastTimelineStatus = currentStatus;

            const steps = document.querySelectorAll('.timeline-step');
            const currentIdx = STEP_ORDER.indexOf(currentStatus);
            const isFailed = currentStatus === 'failed';

            steps.forEach((step) => {
                const stepName = step.dataset.step;
                const stepIdx = STEP_ORDER.indexOf(stepName);

                // Compute desired class
                let desired = '';
                if (isFailed) {
                    if (stepIdx < currentIdx) desired = 'completed';
                    else if (stepIdx === currentIdx) desired = 'failed';
                } else if (currentStatus === 'completed') {
                    desired = 'completed';
                } else if (currentIdx >= 0) {
                    if (stepIdx < currentIdx) desired = 'completed';
                    else if (stepIdx === currentIdx) desired = 'active';
                }

                // Only touch DOM if the class actually needs to change
                const has = step.classList.contains(desired);
                if (!has || (!desired && (step.classList.contains('completed') || step.classList.contains('active') || step.classList.contains('failed')))) {
                    step.classList.remove('completed', 'active', 'failed');
                    if (desired) step.classList.add(desired);
                }
            });
        }

        function updateActivityLog(logEntries) {
            const logEl = document.getElementById('activityLog');
            const logDot = document.getElementById('logDot');

            if (!logEntries || logEntries.length === 0) return;
            if (logEntries.length === lastLogCount) return;

            // Clear empty state on first entry
            if (lastLogCount === 0) {
                logEl.innerHTML = '';
            }

            // Append only new entries
            for (let i = lastLogCount; i < logEntries.length; i++) {
                const entry = logEntries[i];
                const div = document.createElement('div');
                const stepLabel = (entry.step || '').replace(/_/g, ' ');
                const isSuccess = entry.message && (entry.message.startsWith('Done!') || entry.message.includes('valid'));
                const isError = entry.step === 'failed';

                div.className = 'log-entry' + (isSuccess ? ' log-success' : '') + (isError ? ' log-error' : '');
                div.innerHTML = `<span class="log-index">${i + 1}</span><span class="log-step">[${stepLabel}]</span><span class="log-message">${escapeHtml(entry.message)}</span>`;
                logEl.appendChild(div);
            }

            lastLogCount = logEntries.length;

            // Auto-scroll to bottom
            logEl.scrollTop = logEl.scrollHeight;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function updateStatus(workflowId) {
            try {
                const response = await fetch(`/workflows/v1/status/${workflowId}`);
                const data = await response.json();

                const statusEl = document.getElementById('workflowStatus');
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('progressText');

                // Format status text
                const statusText = (data.status || 'unknown').replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                statusEl.textContent = statusText;
                statusEl.className = 'status-value badge badge-' + (data.status || 'unknown');

                // Smooth progress animation
                const progress = data.progress || 0;
                progressBar.style.width = progress + '%';
                progressText.textContent = progress + '%';

                // Update timeline stepper
                updateTimeline(data.status || 'initializing');

                // Update activity log
                updateActivityLog(data.log_entries || []);

                // Update log dot state
                const logDot = document.getElementById('logDot');
                if (data.status === 'completed' || data.status === 'failed') {
                    logDot.classList.add('inactive');
                } else {
                    logDot.classList.remove('inactive');
                }

                // Handle completion
                if (data.status === 'completed' || data.status === 'failed') {
                    clearInterval(pollInterval);
                    setLoading(false);
                    btnText.textContent = 'Start New Generation';

                    if (data.status === 'completed') {
                        showToast('Generation completed successfully! Review your terms now.', 'success');
                        setTimeout(() => {
                            if (confirm('Generation complete! Would you like to review the generated terms?')) {
                                window.location.href = '/review';
                            }
                        }, 500);
                    } else if (data.status === 'failed') {
                        showToast(`Workflow failed: ${data.message || 'Unknown error'}`, 'error');
                    }
                }

            } catch (error) {
                console.error('Error polling status:', error);
            }
        }
    </script>
</body>
</html>
